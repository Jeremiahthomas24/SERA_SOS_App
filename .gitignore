plugins {
    alias(libs.plugins.android.application)
}

android {
    namespace = "com.example.sera"
    compileSdk {
        version = release(36)
    }

    defaultConfig {
        applicationId = "com.example.sera"
        minSdk = 24
        targetSdk = 36
        versionCode = 1
        versionName = "1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
    }
}

dependencies {
    implementation("com.android.volley:volley:1.2.1")
    implementation("com.google.android.gms:play-services-location:21.3.0")
    implementation(libs.appcompat)
    implementation(libs.material)
    testImplementation(libs.junit)
    androidTestImplementation(libs.ext.junit)
    androidTestImplementation(libs.espresso.core)

    // Add Volley here ðŸ‘‡
    implementation("com.android.volley:volley:1.2.1")
}

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:gravity="center_horizontal"
    android:background="#0B0B0B"
    android:padding="20dp">

    <!-- EXTRA SPACE FROM TOP -->
    <Space
        android:layout_width="wrap_content"
        android:layout_height="32dp"/>

    <!-- APP TITLE -->
    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="SERA"
        android:textSize="28sp"
        android:textStyle="bold"
        android:textColor="#FF4D6D"/>

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Smart Emergency Response"
        android:textSize="14sp"
        android:textColor="#AAAAAA"
        android:layout_marginBottom="32dp"/>

    <!-- SOS BUTTON WITH TEXT -->
    <FrameLayout
        android:layout_width="190dp"
        android:layout_height="190dp"
        android:layout_marginBottom="20dp">

        <ImageButton
            android:id="@+id/btnSendSOS"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="@drawable/bg_sos_circle"
            android:contentDescription="SOS"/>

        <TextView
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:text="SOS"
            android:textSize="32sp"
            android:textStyle="bold"
            android:textColor="@android:color/white"
            android:gravity="center"/>
    </FrameLayout>

    <!-- CANCEL SOS -->
    <Button
        android:id="@+id/btnCancelSOS"
        android:layout_width="160dp"
        android:layout_height="48dp"
        android:text="CANCEL SOS"
        android:visibility="gone"
        android:layout_marginBottom="28dp"
        android:backgroundTint="#B00020"
        android:textColor="@android:color/white"/>

    <!-- POLICE & HOSPITAL -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:layout_marginBottom="16dp">

        <TextView
            android:id="@+id/btnPolice"
            android:layout_width="0dp"
            android:layout_height="100dp"
            android:layout_weight="1"
            android:text="Police"
            android:gravity="center"
            android:textSize="16sp"
            android:textColor="@android:color/white"
            android:background="@drawable/bg_card"
            android:layout_marginEnd="8dp"/>

        <TextView
            android:id="@+id/btnAmbulance"
            android:layout_width="0dp"
            android:layout_height="100dp"
            android:layout_weight="1"
            android:text="Ambulance"
            android:gravity="center"
            android:textSize="16sp"
            android:textColor="@android:color/white"
            android:background="@drawable/bg_card"
            android:layout_marginStart="8dp"/>
    </LinearLayout>

    <!-- CALL EMERGENCY CONTACT -->
    <TextView
        android:id="@+id/btnEmergencyCall"
        android:layout_width="match_parent"
        android:layout_height="60dp"
        android:text="Call Emergency Contact"
        android:gravity="center"
        android:textSize="16sp"
        android:textColor="@android:color/white"
        android:background="@drawable/bg_card"/>

</LinearLayout>

<shape xmlns:android="http://schemas.android.com/apk/res/android"
    android:shape="oval">
    <solid android:color="#FF1744"/>
    <stroke
        android:width="6dp"
        android:color="#FF5C8A"/>
</shape>

<?xml version="1.0" encoding="utf-8"?>
<resources>

    <style name="GridItemDark">
        <item name="android:layout_width">0dp</item>
        <item name="android:layout_height">100dp</item>
        <item name="android:layout_columnWeight">1</item>
        <item name="android:background">@drawable/bg_grid_item</item>
        <item name="android:gravity">center</item>
        <item name="android:orientation">vertical</item>
        <item name="android:clickable">true</item>
        <item name="android:focusable">true</item>
    </style>

    <style name="GridItemBlue" parent="GridItemDark">
        <item name="android:background">@android:color/holo_blue_dark</item>
    </style>

    <style name="GridItemYellow" parent="GridItemDark">
        <item name="android:background">@android:color/holo_orange_dark</item>
    </style>

    <style name="GridText">
        <item name="android:textColor">@android:color/white</item>
        <item name="android:textSize">14sp</item>
        <item name="android:layout_marginTop">6dp</item>
    </style>

</resources>

<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.sera">

    <!-- Location permissions -->
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>

    <!-- Emergency communication -->
    <uses-permission android:name="android.permission.SEND_SMS"/>
    <uses-permission android:name="android.permission.CALL_PHONE"/>
    <uses-permission android:name="android.permission.VIBRATE"/>

    <!-- Declare hardware safely -->
    <uses-feature
        android:name="android.hardware.telephony"
        android:required="false"/>

    <uses-feature
        android:name="android.hardware.location.gps"
        android:required="false"/>
    <application
        android:allowBackup="true"
        android:label="@string/app_name"
        android:icon="@mipmap/ic_launcher"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:theme="@style/Theme.MaterialComponents.DayNight.NoActionBar">

        <activity
            android:name=".MainActivity"
            android:exported="true">

            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>

        </activity>

    </application>
</manifest>

package com.example.sera;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;

import android.Manifest;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.location.Location;
import android.location.LocationManager;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.os.VibrationEffect;
import android.os.Vibrator;
import android.provider.Settings;
import android.telephony.SmsManager;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.ImageButton;
import android.widget.TextView;
import android.widget.Toast;

import com.android.volley.Request;
import com.android.volley.RequestQueue;
import com.android.volley.toolbox.JsonObjectRequest;
import com.android.volley.toolbox.Volley;
import com.google.android.gms.location.FusedLocationProviderClient;
import com.google.android.gms.location.LocationServices;

import org.json.JSONObject;
Customize Toolbarâ€¦

    // ---------------- PERMISSIONS ----------------
    private void requestAllPermissions() {
        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
                != PackageManager.PERMISSION_GRANTED ||
                ActivityCompat.checkSelfPermission(this, Manifest.permission.SEND_SMS)
                        != PackageManager.PERMISSION_GRANTED ||
                ActivityCompat.checkSelfPermission(this, Manifest.permission.CALL_PHONE)
                        != PackageManager.PERMISSION_GRANTED) {

            ActivityCompat.requestPermissions(this, new String[]{
                    Manifest.permission.ACCESS_FINE_LOCATION,
                    Manifest.permission.SEND_SMS,
                    Manifest.permission.CALL_PHONE,
                    Manifest.permission.VIBRATE
            }, REQ_PERM);
        }
    }

    // ---------------- SOS FLOW ----------------
    private void startDelayedSOS(Button cancelBtn) {
        sosCancelled = false;
        cancelBtn.setVisibility(View.VISIBLE);

        Toast.makeText(
                this,
                "Sending SOS in 5 secondsâ€¦ Tap CANCEL to stop",
                Toast.LENGTH_LONG
        ).show();

        sosRunnable = () -> {
            cancelBtn.setVisibility(View.GONE);
            if (!sosCancelled) startSOS();
        };

        sosHandler.postDelayed(sosRunnable, 5000);
    }

    private void startSOS() {
        if (!isLocationEnabled()) {
            Toast.makeText(this, "Please enable GPS", Toast.LENGTH_SHORT).show();
            startActivity(new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS));
            return;
        }

        if (ActivityCompat.checkSelfPermission(this,
                Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
            return;
        }

        fusedLocationClient.getLastLocation()
                .addOnSuccessListener(location -> {
                    if (location != null) {
                        handleLocation(location);
                    } else {
                        Toast.makeText(this, "Location unavailable", Toast.LENGTH_SHORT).show();
                    }
                });
    }

    private void handleLocation(Location location) {
        String loc = location.getLatitude() + "," + location.getLongitude();
        sendSMS(loc);
        sendToServer(loc);
    }

    private void sendSMS(String loc) {
        String msg = "ðŸš¨ SERA SOS\nLocation: https://maps.google.com/?q=" + loc;
        SmsManager sms = SmsManager.getDefault();

        sms.sendTextMessage(CONTACT1, null, msg, null, null);
        sms.sendTextMessage(CONTACT2, null, msg, null, null);
        sms.sendTextMessage(CONTACT3, null, msg, null, null);

        Toast.makeText(this, "SOS sent to contacts", Toast.LENGTH_SHORT).show();
    }

    // ---------------- CALLING ----------------
    private void callNumber(String number) {
        try {
            if (ActivityCompat.checkSelfPermission(this,
                    Manifest.permission.CALL_PHONE) == PackageManager.PERMISSION_GRANTED) {

                startActivity(new Intent(
                        Intent.ACTION_CALL,
                        Uri.parse("tel:" + number)
                ));
            } else {
                // Permission-safe fallback
                startActivity(new Intent(
                        Intent.ACTION_DIAL,
                        Uri.parse("tel:" + number)
                ));
            }
        } catch (Exception e) {
            Toast.makeText(this, "Unable to place call", Toast.LENGTH_SHORT).show();
        }
    }

    // ---------------- SERVER ----------------
    private void sendToServer(String loc) {
        try {
            JSONObject body = new JSONObject();
            body.put("type", "SOS");
            body.put("location", loc);

            JsonObjectRequest req = new JsonObjectRequest(
                    Request.Method.POST,
                    SOS_URL,
                    body,
                    response -> {},
                    error -> Log.e("SERVER", error.toString())
            );

            requestQueue.add(req);
        } catch (Exception ignored) {}
    }

    // ---------------- UTILITIES ----------------
    private boolean isLocationEnabled() {
        LocationManager lm =
                (LocationManager) getSystemService(Context.LOCATION_SERVICE);

        return lm != null &&
                (lm.isProviderEnabled(LocationManager.GPS_PROVIDER)
                        || lm.isProviderEnabled(LocationManager.NETWORK_PROVIDER));
    }

    private void vibratePhone() {
        Vibrator v = (Vibrator) getSystemService(VIBRATOR_SERVICE);
        if (v == null) return;

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            v.vibrate(VibrationEffect.createOneShot(
                    700,
                    VibrationEffect.DEFAULT_AMPLITUDE
            ));
        } else {
            v.vibrate(700);
        }
    }

    @Override
    public void onRequestPermissionsResult(
            int requestCode,
            @NonNull String[] permissions,
            @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    }
}
